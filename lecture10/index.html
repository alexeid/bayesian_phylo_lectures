---
lecture_num: 10
---
<section>
	<h2>The coalescent</h2>
	
	<div align="left" style="margin-top:5%; margin-left:5%; width:85%">
	Data: a <font color="red">small genetic sample</font> from a <font color="red">large background population</font>. 
	<br><br>
	The coalescent
	</div>
	
	<ul class="spaced" style="margin-top:1%; width:80%">
	<li>is a model of the ancestral relationships of a sample of individuals taken from a larger population.
	<li>describes a probability distribution on ancestral genealogies (trees) given a population history, N(t).
	<li>Therefore the coalescent can convert information from ancestral genealogies into information about population history and vice versa.
	<li>a model of ancestral genealogies, not sequences, and its simplest form assumes neutral evolution.
	<li>can be thought of as a prior on the tree, in a Bayesian setting.
	</ul>	
</section>

<section>
	<h2>Theoretical population genetics</h2>
	
	<div style="float:right; width:35%">
		<img data-src="wrightFisher.png" style="width:100%">
</div>

	<div style="float:left; margin-left:5%; width:55%">
	<div align="left" style="margin-top:5%">
	Most of theoretical population genetics is based on the idealized Wright-Fisher model of population which assumes
	</div>

	<ul class="spaced" style="margin-top:2%">
	<li>Constant population size N 	
	<li>Discrete generations
	<li>Complete mixing
	</ul>	

	<div align="left" style="">
	For the purposes of this presentation the population will be assumed to be haploid, as is the case for many pathogens.
	</div>
	</div>
	
</section>

<section>
	<h2>Kingman's n-coalescent</h2>
	
	<div style="float:right; width:35%">
		<img data-src="wfCoalescent3.png" style="width:100%">
</div>

	<div style="float:left; margin-left:5%; width:55%">
	<div align="left" style="margin-top:5%">
<p>Consider tracing the ancestry of a sample of $k$ individuals from the present, back into the past.</p>

<p>This process eventually coalesces to a single common ancestor (concestor) of the sample of individuals.</p>

<p>Kingman’s n-coalescent describes the statistical properties of such an ancestry when $k$ is small compared to the total population size $N$.</p>
	</div>

</section>

<section>
	<h2>The coalescence of two ancestral lineages</h2>
	
	<div style="float:right; width:35%">
		<img data-src="wfCoalescent2.png" style="width:100%">
</div>

	<div style="float:left; margin-left:5%; width:55%">
	<div align="left" style="margin-top:5%">
	<ul class="spaced">
<li>First, consider two random members from a population of fixed size $N$.
<li>By perfect mixing, the probability they share a concestor in the previous generation is $1/N$.
<li> The probability the concestor is $t$ generations back is
$$\Pr(t)= \frac{1}{N}(1−\frac{1}{N})^{t−1}.$$
<li>  It follows that $g=t−1$,has a geometric distribution with a success rate of $\lambda = 1/N$, and so has mean $N$ and variance of $N^3/(N − 1)$.


	</div>

</section>


<section>
	<h2>The coalescence of k lineages</h2>
	
	<div style="float:right; width:35%">
		<img data-src="wfCoalescent3.png" style="width:100%">
</div>

	<div style="float:left; margin-left:5%; width:55%">
	<div align="left" style="margin-top:5%">
<p>With $k$ lineages the time to the first coalescence is derived in the same way,
only now there are $k \choose 2$ possible pairs that may coalesce, resulting in a success rate of $\lambda = {k \choose 2}/N$.</p>

<p> The mean time to first coalescence ($t_k$) of is:
       $$E[t_k] = \frac{N}{k \choose 2}.$$</p>
<p>This implicitly assumes that $N$ is much larger than $O(k^2)$, so that the probability of two coalescent events in the same generation is small.</p>

</section>

<section>
<h2>The exponential distribution</h2>

<p>The geometric distribution converges to the exponential distribution as the population 
size becomes larger and the rate of coalescence becomes smaller.</p>

<img data-src="distribution_comparison.png" style="width:65%">

</section>

<section>
<h2>The coalescent is a <i>diffusion approximation</i></h2>

	<div style="float:right; width:49.99%">
		<img data-src="wrightFisherToTree.png" style="width:100%">
</div>

<div style="float:left; margin-left:0%; width:50%">
<p>Kingman (1982) showed that as $N$ grows the coalescent process converges to a
continuous-time Markov chain.</p>


<p>$\lambda = \binom{k}{2}/N$ is the rate of coalescence, i.e. the probability of coalescing a pair from $k$ lineages on a short time
interval $\Delta t$ is $O({\lambda\Delta t})$. Unsurprisingly the solution turns out to be the exponential distribution:</p>

$$f(t_k)=\frac{ {k \choose 2} }{N}\exp\left(-\frac{ {k \choose 2}t_k}{N}\right)\,,$$

<p>or more relevant to a tree hypothesis, for a <i>specific</i> pair of lineages:</p>

$$f(t_k)=\frac{1}{N}\exp\left(-\frac{ {k \choose 2}t_k}{N}\right)\,.$$


</div>
</section>

<section>
	<h2>The coalescent density for a genealogy</h2>
	
	<p> For a genealogy $g$ with coalescent times $\mathbf{t} = \{t_2, t_3, \dots, t_n\}$ we can write the probability density of the genealogy:</p>
	
	<p>$$P(g|N)=\frac{1}{N^{n-1}}\prod_{k=2}^n\exp\left(-\frac{ {k \choose 2}t_k}{N}\right)\,.$$</p>
	
	
	<img data-src="wrightFisherToTree.png" style="width:60%">

</section>

<section>

<h2>The coalescent density with varying population size</h2>

<p>The generalization of the coalescent for the case where the
population size changes over time, $N = N(t)$ is given by Griffiths and Tavare (1994).</p>

<p>They showed that the coalescent density for the first coalescence event being at time $t$ in the past given $n$ lineages is:

<p>$$
f(t) = {\frac{\binom{n}{2} }{N(t)} }  
{\exp\left(-{\int \limits_0^t \frac{\binom{n}{2} }{N(x)} dx }\right)} 
$$
</p>

<p> So as long as the coalescent intensity function $\frac{1}{N(t)}$ is integrable with respect to $t$, then the coalescent density of a tree can be computed for population size function $N(t)$. 

</section>

<section>

	<div id="container">		
		<div class="input-container" id="input-container">
				
			<div class="container-title" style="font-size:12pt"> Controls </div>
				<div style="background-color: #ccccff;  text-align:center;">	

					<button onclick="advance(1)">advance</button>
					<button onclick="advance(1000)">advance 1000</button>
                    			<button onclick="nextGeneration()">next generation</button><br>
					<button onclick="run()">run</button>
					<button onclick="stop()">stop</button>
					<button onclick="clearCoalescentDensity();drawWrightFisher();">clear density</button>
				</div>


			<div class="container-title" style="font-size:12pt">Visualisation</div>
				<div class="container-contents">	

				<div class="form-element">
						<div class="label" >Animation speed (gen/sec)</div><div class="input">
                            <input name="animationSpeed" id="animationSpeed" type="number" min="1" max="50" value="15" /></div>
					</div>
					<div class="form-element">
                        <div class="label" >mark individuals</div><div class="input">
                            <input type='checkbox' checked="true" onclick='setPlotVertices(this);' ></div>
					</div>
					<div class="form-element">
						<div class="label" >mark coalescent events</div><div class="input">
                            <input type='checkbox' checked="true" onclick='setPlotCoalescence(this);' ></div>
					</div>
					<div class="form-element">
						<div class="label" >show coalescent density</div><div class="input">
                            <input type='checkbox' checked="true" onclick='setPlotCoalescenceDensity(this);' ></div>
					</div>
				</div>

                <div class="container-title" style="font-size:12pt">Simulation parameters</div>
				<div class="container-contents" >	
					<div class="form-element">
						<div class="label" for="sampleSize">sample size (n) = </div><div class="input">
                            <input name="sampleSize" id="sampleSize" type="number" min="2" max="10" value="2"/></div>
					</div>
			
					<div class="form-element">
						<div class="label" for="G">number of generations (G) = </div><div class="input">
                            <input name="G" id="G" type="number" min="2" max="99" value="64"/></div>
					</div>

				</div>
				
                <div class="container-title" style="font-size:12pt">Population size function parameters </div>
				<div class="container-contents">	
			
					<div class="form-element">
						<div class="label" for="N">population size (N) = </div><div class="input">
                            <input name="N" id="N" type="number" min="2" max="99" value="32"/></div>
					</div>
			
					<div class="form-element">
						<div class="label" for="wavelength">Time between bottlenecks (wavelength) = </div><div class="input">
                            <input name="wavelength" id="wavelength" type="number" min="2" max="99" value="16"/></div>
					</div>

					<div class="form-element">
						<div class="label" for="N_bottleneck">Bottleneck population size (N_bottleneck) = </div><div class="input">
                            <input name="N_bottleneck" id="N_bottleneck" type="number" min="1" max="99" value="8"/></div>
					</div>

                    <div class="form-element pf">
                        <div class="label pf"> Population function: </div><div class="input pf">
                            <input type="radio" name="popfunc" value="sinusoid" checked>Sinusoidal<br>
                            <input type="radio" name="popfunc" value="squarewave">Square wave<br>
                            <input type="radio" name="popfunc" value="sawtooth">Saw tooth<br>
                            <input type="radio" name="popfunc" value="custom">Custom:<br>
                            <textarea id="customPopFunc" rows="2" disabled>N-amp + Math.random()*amp</textarea>
                        </div>
                    </div>
				</div>
			</div>
			<div id="canvas-container" style="margin:0 auto; overflow:hidden; height:100%; text-align:center;">
				<canvas id="canvas" width="50%" height="600">
					<script src="wrightFisher.js"></script>
				</canvas>
			</div>
		<div style="clear:both;"></div>

</section>
